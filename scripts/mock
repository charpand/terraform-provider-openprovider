#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/.."

if [[ -n "$1" && "$1" != '--'* ]]; then
  URL="$1"
  shift
else
  # Use local openapi-swagger.json if it exists, otherwise fall back to .stats.yml
  if [ -f "openapi-swagger.json" ]; then
    URL="openapi-swagger.json"
  else
    URL="$(grep 'openapi_spec_url' .stats.yml | cut -d' ' -f2)"
  fi
fi

# Check if the URL is empty
if [ -z "$URL" ]; then
  echo "Error: No OpenAPI spec path/url provided or found in openapi-swagger.json or .stats.yml"
  exit 1
fi

echo "==> Starting mock server with ${URL}"

# Run prism mock on the given spec
# If the URL is an http(s) URL, download it to a temporary file first to avoid
# certain Node/Prism resolver issues related to AbortSignal instances.
downloaded_spec=""
if [[ "$URL" =~ ^https?:// ]]; then
  tmpfile=$(mktemp .tmp-openapi-swagger.json.XXXXXX)
  echo "Downloading ${URL} to ${tmpfile}"
  if command -v curl >/dev/null 2>&1; then
    curl -fsSL "${URL}" -o "${tmpfile}"
  elif command -v wget >/dev/null 2>&1; then
    wget -qO "${tmpfile}" "${URL}"
  else
    echo "Error: neither curl nor wget is available to download ${URL}" >&2
    exit 1
  fi
  downloaded_spec="${tmpfile}"
  URL="${downloaded_spec}"
fi

if [ "$1" == "--daemon" ]; then
  npm exec --package=@stoplight/prism-cli@5.14.2 -- prism mock "$URL" &> .prism.log &

  # Wait for server to come online
  echo -n "Waiting for server"
  while ! grep -q "✖  fatal\|Prism is listening" ".prism.log" ; do
    echo -n "."
    sleep 0.1
  done

  if grep -q "✖  fatal" ".prism.log"; then
    cat .prism.log
    exit 1
  fi

  echo
else
  npm exec --package=@stoplight/prism-cli@5.14.2 -- prism mock "$URL"
fi

# Cleanup downloaded temp file on exit
if [ -n "${downloaded_spec}" ]; then
  rm -f "${downloaded_spec}"
fi
